"use strict";(()=>{var e={};e.id=6665,e.ids=[6665],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},66756:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{POST:()=>u});var s=t(73278),a=t(45002),i=t(54877),n=t(71309),l=t(53524),c=t(16910);let d=new l.PrismaClient;async function u(e){try{let{firstName:r,lastName:t,email:o,phone:s,employeeId:a,password:i,requestedRoleId:l,departmentId:u,institutionName:p,purpose:m}=await e.json();if(console.log("\uD83D\uDE80 Direct registration attempt:",{employeeId:a,email:o,firstName:r,lastName:t}),await d.user.findUnique({where:{email:o}}))return n.NextResponse.json({error:"An account with this email already exists"},{status:400});if(await d.user.findUnique({where:{employeeId:a}}))return n.NextResponse.json({error:"This Employee ID is already registered"},{status:400});let f=await (0,c.c_)(i);console.log("✅ Creating user account directly...");let g=await d.user.create({data:{employeeId:a,firstName:r,lastName:t,email:o,phone:s||null,password:f,roleId:parseInt(l),departmentId:u?parseInt(u):null,isActive:!0,profileColor:`#${Math.floor(16777215*Math.random()).toString(16)}`,profileInitials:`${r[0]}${t[0]}`.toUpperCase()},include:{role:!0,department:!0}});console.log("✅ User created successfully:",{id:g.id,employeeId:g.employeeId,name:`${g.firstName} ${g.lastName}`,role:g.role.name,isActive:g.isActive});try{await fetch(`${e.nextUrl.origin}/api/notifications/email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"account_created",to:o,userName:`${r} ${t}`,employeeId:a,password:i})}),console.log("\uD83D\uDCE7 Welcome email sent successfully")}catch(e){console.error("\uD83D\uDCE7 Failed to send welcome email:",e)}return n.NextResponse.json({success:!0,message:"Account created successfully! You can now login.",user:{id:g.id,employeeId:g.employeeId,firstName:g.firstName,lastName:g.lastName,email:g.email,role:g.role.name,department:g.department?.name||"No department"},loginCredentials:{employeeId:g.employeeId,password:i,loginUrl:`${e.nextUrl.origin}/login`}})}catch(e){return console.error("Direct registration error:",e),n.NextResponse.json({error:"Failed to create account",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/register-direct/route",pathname:"/api/register-direct",filename:"route",bundlePath:"app/api/register-direct/route"},resolvedPagePath:"/workspace/app/api/register-direct/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=p,y="/api/register-direct/route";function w(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},16910:(e,r,t)=>{t.d(r,{Gv:()=>n,RA:()=>l,So:()=>c,c_:()=>i});var o=t(67390),s=t(93981);let a=new(t(53524)).PrismaClient,i=async e=>await s.vp(e,12),n=async(e,r)=>await s.qu(e,r),l=e=>{let r=process.env.JWT_SECRET||"fallback-secret-key";return o.sign({id:e.id,employeeId:e.employeeId,firstName:e.firstName,lastName:e.lastName,email:e.email,role:e.role,department:e.department},r,{expiresIn:"7d"})},c=async(e,r)=>{try{console.log(`🔍 Authentication attempt for Employee ID: ${e}`);let t=await a.user.findUnique({where:{employeeId:e},include:{role:!0,department:!0}});if(!t)return console.log(`❌ User not found for Employee ID: ${e}`),null;if(!t.password)return console.log(`❌ User ${e} has no password set`),null;console.log(`✅ User found: ${t.firstName} ${t.lastName} (${t.employeeId})`),console.log(`✅ User active: ${t.isActive}`),console.log(`✅ Password hash exists: ${!!t.password}`);let o=await n(r,t.password);if(console.log(`🔑 Password validation result: ${o}`),!o)return console.log(`❌ Invalid password for user: ${e}`),null;if(!t.isActive)return console.log(`❌ User ${e} is not active`),null;return{id:t.id,employeeId:t.employeeId,firstName:t.firstName,lastName:t.lastName,email:t.email,role:t.role.name,department:t.department?.name||"Unknown",isActive:t.isActive}}catch(e){return console.error("Authentication error:",e),null}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[7787,4833,5990],()=>t(66756));module.exports=o})();